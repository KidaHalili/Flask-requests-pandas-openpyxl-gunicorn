<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Distancë & Karburant</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/static/style.css">

  <!-- Google Places -->
<script
  src="https://maps.googleapis.com/maps/api/js?key={{ google_key }}&libraries=places&language=sq&region=AL"
  defer>
</script>
</head>

<body>
  <div class="bg"></div>

  <main class="container">
    <section class="card">
      <header class="header">
        <div class="logo">
          <i class="fa-solid fa-route"></i>
        </div>
        <div class="title">
          <h1>Llogaritje Distancë & Karburant</h1>
          <p>Naftë · Çmim reference (Kastrati) · Raport Excel</p>
        </div>
      </header>

      <div class="top-grid">
        <div class="field">
          <label><i class="fa-solid fa-location-dot"></i> Nga</label>
          <input id="origin" type="text" value="{{ origin }}" disabled>
        </div>

        <div class="field">
          <label><i class="fa-solid fa-arrow-right-arrow-left"></i> Udhëtimi</label>
          <select id="trip">
            <option value="oneway">Vetëm vajtje</option>
            <option value="round">Vajtje – Ardhje</option>
          </select>
          <div class="hint">“Vajtje – Ardhje” llogarit automatikisht dyfish.</div>
        </div>

        <div class="field">
          <label><i class="fa-solid fa-gauge-high"></i> Konsum (L/100km)</label>
          <input id="cons" type="number" step="0.1" min="1" value="{{ defaults.cons }}">
        </div>

        <div class="field">
          <label><i class="fa-solid fa-coins"></i> Çmimi naftës (lek/L)</label>
          <input id="price" type="number" step="0.1" min="1" value="{{ defaults.price }}">
        </div>
      </div>

      <div class="toolbar">
        <button class="btn" id="addRowBtn" type="button">
          <i class="fa-solid fa-plus"></i> Shto destinacion
        </button>

        <button class="btn btn-ghost" id="calcAllBtn" type="button">
          <i class="fa-solid fa-calculator"></i> Llogarit të gjitha
        </button>

        <button class="btn btn-dark" id="excelBtn" type="button" disabled>
          <i class="fa-solid fa-file-excel"></i> Shkarko Excel
        </button>
      </div>

      <div class="table-wrap">
        <table class="tbl">
          <thead>
            <tr>
              <th style="width:44px">#</th>
              <th>Destinacioni</th>
              <th style="width:120px">KM</th>
              <th style="width:140px">Karburant (L)</th>
              <th style="width:140px">Kosto (lek)</th>
              <th style="width:54px"></th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="totals">
        <div class="tcard">
          <div class="tic"><i class="fa-solid fa-road"></i></div>
          <div>
            <div class="tlabel">Total KM</div>
            <div class="tval" id="totalKm">0</div>
          </div>
        </div>

        <div class="tcard">
          <div class="tic"><i class="fa-solid fa-gas-pump"></i></div>
          <div>
            <div class="tlabel">Total L</div>
            <div class="tval" id="totalFuel">0</div>
          </div>
        </div>

        <div class="tcard tstrong">
          <div class="tic"><i class="fa-solid fa-coins"></i></div>
          <div>
            <div class="tlabel">Total Lek</div>
            <div class="tval" id="totalCost">0</div>
          </div>
        </div>
      </div>

      <div class="note">
        <i class="fa-solid fa-circle-info"></i>
        <span>Shkruaj destinacionin dhe zgjidhe nga sugjerimet e Google. Pastaj “Llogarit të gjitha” ose llogarit automatikisht kur zgjedh destinacionin.</span>
      </div>
    </section>
  </main>

<script>
  const GOOGLE_KEY = "VENDOS_API_KEY_KETU"; // (nuk përdoret këtu sepse script-i është sipër, por e lë për qartësi)

  const rowsEl = document.getElementById("rows");
  const addRowBtn = document.getElementById("addRowBtn");
  const calcAllBtn = document.getElementById("calcAllBtn");
  const excelBtn = document.getElementById("excelBtn");

  const tripEl = document.getElementById("trip");
  const consEl = document.getElementById("cons");
  const priceEl = document.getElementById("price");
  const originEl = document.getElementById("origin");

  const totalKmEl = document.getElementById("totalKm");
  const totalFuelEl = document.getElementById("totalFuel");
  const totalCostEl = document.getElementById("totalCost");

  let rowId = 0;

  function money(n){ return (Number(n)||0).toFixed(0); }
  function num2(n){ return (Number(n)||0).toFixed(2); }

  function recalcTotals(){
    let tk=0, tf=0, tc=0;
    [...rowsEl.querySelectorAll("tr")].forEach(tr=>{
      tk += Number(tr.dataset.km||0);
      tf += Number(tr.dataset.fuel||0);
      tc += Number(tr.dataset.cost||0);
    });
    totalKmEl.textContent = num2(tk);
    totalFuelEl.textContent = num2(tf);
    totalCostEl.textContent = money(tc);

    // aktivizo excel vetëm nëse ka të paktën 1 rresht të llogaritur
    excelBtn.disabled = (tk <= 0);
  }

  function makeRow(){
    rowId++;
    const tr = document.createElement("tr");
    tr.dataset.id = String(rowId);
    tr.dataset.placeid = "";
    tr.dataset.km = "0";
    tr.dataset.fuel = "0";
    tr.dataset.cost = "0";

    tr.innerHTML = `
      <td class="idx">${rowId}</td>
      <td>
        <div class="dest">
          <i class="fa-solid fa-flag-checkered"></i>
          <input class="destInput" type="text" placeholder="Shkruaj destinacionin (p.sh. Shkolla Kozare, Kuçovë)" autocomplete="off">
        </div>
        <div class="mini">Zgjidhe nga sugjerimet e Google.</div>
      </td>
      <td class="mono km">—</td>
      <td class="mono fuel">—</td>
      <td class="mono cost">—</td>
      <td class="actions">
        <button class="iconBtn del" type="button" title="Fshi"><i class="fa-solid fa-trash"></i></button>
      </td>
    `;

    rowsEl.appendChild(tr);

    const input = tr.querySelector(".destInput");
    const delBtn = tr.querySelector(".del");

    delBtn.addEventListener("click", ()=>{
      tr.remove();
      recalcTotals();
      renumber();
    });

    // Init autocomplete vetëm pasi google të jetë gati
    const waitGoogle = setInterval(()=>{
      if (window.google && google.maps && google.maps.places){
        clearInterval(waitGoogle);
        const ac = new google.maps.places.Autocomplete(input, {
          componentRestrictions: { country: "al" },
          fields: ["place_id", "formatted_address", "name"]
        });

        ac.addListener("place_changed", async ()=>{
          const place = ac.getPlace();
          if (!place || !place.place_id){
            tr.dataset.placeid = "";
            return;
          }
          tr.dataset.placeid = place.place_id;

          // vendos label më të bukur
          const label = place.formatted_address || input.value;
          input.value = label;

          // llogarit menjëherë këtë rresht
          await calcRow(tr);
        });

        // Nëse shkruan manualisht, pastro rezultatet e vjetra
        input.addEventListener("input", ()=>{
          tr.dataset.placeid = "";
          tr.dataset.km = "0"; tr.dataset.fuel="0"; tr.dataset.cost="0";
          tr.querySelector(".km").textContent = "—";
          tr.querySelector(".fuel").textContent = "—";
          tr.querySelector(".cost").textContent = "—";
          recalcTotals();
        });
      }
    }, 150);

    return tr;
  }

  function renumber(){
    [...rowsEl.querySelectorAll("tr")].forEach((tr, i)=>{
      tr.querySelector(".idx").textContent = (i+1);
    });
  }

  async function calcRow(tr){
    const placeId = tr.dataset.placeid;
    if (!placeId){
      return;
    }

    const payload = {
      place_id: placeId,
      trip: tripEl.value,
      cons: consEl.value,
      price: priceEl.value
    };

    // UI loading
    tr.querySelector(".km").textContent = "…";
    tr.querySelector(".fuel").textContent = "…";
    tr.querySelector(".cost").textContent = "…";

    const res = await fetch("/api/calc", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(()=> ({}));

    if (!res.ok || !data.ok){
      tr.querySelector(".km").textContent = "ERR";
      tr.querySelector(".fuel").textContent = "ERR";
      tr.querySelector(".cost").textContent = "ERR";
      tr.dataset.km="0"; tr.dataset.fuel="0"; tr.dataset.cost="0";
      recalcTotals();
      alert("Gabim te llogaritja: " + (data.error || "Nuk u gjet rrugë"));
      return;
    }

    tr.dataset.km = String(data.km);
    tr.dataset.fuel = String(data.fuel_l);
    tr.dataset.cost = String(data.cost_lek);

    tr.querySelector(".km").textContent = num2(data.km);
    tr.querySelector(".fuel").textContent = num2(data.fuel_l);
    tr.querySelector(".cost").textContent = money(data.cost_lek);

    recalcTotals();
  }

  async function calcAll(){
    const trs = [...rowsEl.querySelectorAll("tr")];
    for (const tr of trs){
      if (tr.dataset.placeid){
        // llogarit
        await calcRow(tr);
      }
    }
  }

  async function exportExcel(){
    const rows = [...rowsEl.querySelectorAll("tr")]
      .filter(tr => Number(tr.dataset.km||0) > 0)
      .map(tr => ({
        destination: tr.querySelector(".destInput").value,
        km: Number(tr.dataset.km||0),
        fuel_l: Number(tr.dataset.fuel||0),
        cost_lek: Number(tr.dataset.cost||0)
      }));

    if (!rows.length){
      alert("S’ka të dhëna për Excel. Llogarit së pari.");
      return;
    }

    const tripLabel = tripEl.value === "round" ? "Vajtje – Ardhje" : "Vetëm vajtje";

    const payload = {
      origin: originEl.value,
      trip_label: tripLabel,
      cons: Number(consEl.value),
      price: Number(priceEl.value),
      rows
    };

    const r = await fetch("/export_excel", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    if (!r.ok){
      alert("Nuk u krijua Excel.");
      return;
    }

    const blob = await r.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "raport_distanca_karburant.xlsx";
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  }

  // Events
  addRowBtn.addEventListener("click", ()=> makeRow());
  calcAllBtn.addEventListener("click", ()=> calcAll());
  excelBtn.addEventListener("click", ()=> exportExcel());

  // Kur ndryshon trip/konsum/cmim -> rillogarit të llogariturat
  [tripEl, consEl, priceEl].forEach(el=>{
    el.addEventListener("change", ()=> calcAll());
  });

  // start me 1 rresht
  makeRow();
</script>

</body>
</html>
